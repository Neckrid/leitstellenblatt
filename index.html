<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LSPD Leitstelle – Leitstellenblatt</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#fff;
      overflow:hidden;

      background:
        radial-gradient(1200px 700px at 12% 18%, rgba(0,255,195,0.10), transparent 60%),
        radial-gradient(900px 650px at 88% 72%, rgba(255,70,180,0.08), transparent 62%),
        radial-gradient(760px 520px at 72% 20%, rgba(0,140,255,0.10), transparent 60%),
        linear-gradient(180deg, #05070c, #070a12 40%, #05060b);
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:14px;
      padding:14px;
    }

    .panel{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(14, 18, 28, 0.55);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.20), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.16);
      display:grid; place-items:center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      font-weight:800;
      letter-spacing:0.5px;
    }
    .titleWrap{ line-height:1.05; }
    .title{ font-size:14px; font-weight:800; letter-spacing:0.6px; }
    .subtitle{ font-size:12px; opacity:0.75; }

    .content{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    .row{ display:flex; gap:10px; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    .field{
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px;
    }
    label{ font-size:12px; opacity:0.75; display:block; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:120px; }

    .btn{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.2px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(0,255,195,0.22), rgba(0,140,255,0.18));
      border-color: rgba(0,255,195,0.25);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(255,70,180,0.18), rgba(255,70,70,0.16));
      border-color: rgba(255,70,180,0.25);
    }
    .btnGhost{
      background: transparent;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      opacity:0.92;
      white-space:nowrap;
    }

    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }
    .dot.on{ background: rgba(0,255,195,0.95); box-shadow: 0 0 0 3px rgba(0,255,195,0.12), 0 0 18px rgba(0,255,195,0.35); }
    .dot.off{ background: rgba(255,70,180,0.90); box-shadow: 0 0 0 3px rgba(255,70,180,0.12), 0 0 18px rgba(255,70,180,0.28); }

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius:16px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .item strong{ font-size:14px; }
    .muted{ opacity:0.75; font-size:12px; }
    .mini{ font-size:12px; opacity:0.85; }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(260px, 1fr));
      gap:14px;
    }

    .card{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.25);
    }
    .cardHeader{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .patrolName{
      font-weight:900;
      letter-spacing:0.4px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .patrolName input{
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.3px;
    }

    .cardBody{ padding:12px; }
    .officerLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      margin-bottom:10px;
    }
    .officerLine:last-child{ margin-bottom:0; }

    .rightBox h3{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:0.6px;
      opacity:0.9;
    }
    .codeList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .codeRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .codeRow b{ font-size:12px; white-space:nowrap; }
    .codeRow span{ font-size:12px; opacity:0.82; }

    .topActions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(10,12,18,0.72);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size:13px;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    @media (max-width: 1200px){
      body{ overflow:auto; }
      .app{
        height:auto;
        grid-template-columns: 1fr;
      }
      .grid{
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT: Anmeldung / Dienstliste -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">LSPD</div>
          <div class="titleWrap">
            <div class="title">LEITSTELLE</div>
            <div class="subtitle">Dienst & Streifenverwaltung</div>
          </div>
        </div>
        <span class="pill" id="connPill"><span class="dot off" id="connDot"></span><span id="connText">offline</span></span>
      </div>

      <div class="content">
        <div class="field">
          <label>Beamter</label>
          <div class="row">
            <input id="inpName" placeholder="Name (z.B. John Doe)"/>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <input id="inpCallsign" placeholder="Callsign (z.B. 1A-12)"/>
          </div>

          <div style="height:10px"></div>
          <label>Streife</label>
          <select id="selPatrol"></select>

          <div style="height:12px"></div>
          <div class="row">
            <button class="btn btnPrimary" id="btnOn">10-1 Im Dienst</button>
            <button class="btn btnDanger" id="btnOff">10-2 Außer Dienst</button>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn btnGhost" id="btnRemember">Eingaben merken</button>
            <span class="muted" id="meHint"></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <label style="margin:0;">Beamte im Dienst</label>
            <span class="pill"><span class="dot on"></span><span id="onCount">0</span></span>
          </div>
          <div style="height:10px"></div>
          <div class="list" id="onDutyList"></div>
        </div>
      </div>
    </section>

    <!-- CENTER: Streifen -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">10</div>
          <div class="titleWrap">
            <div class="title">STREIFENEINTEILUNG</div>
            <div class="subtitle">Zuweisungen & Status in Echtzeit</div>
          </div>
        </div>
        <div class="topActions">
          <button class="btn" id="btnAddPatrol">+ Streife</button>
          <button class="btn btnGhost" id="btnRefresh">Aktualisieren</button>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="patrolGrid"></div>
      </div>
    </section>

    <!-- RIGHT: Notizen / Codes -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">⟡</div>
          <div class="titleWrap">
            <div class="title">LEITSTELLEN-TOOLS</div>
            <div class="subtitle">Notizen, Funcodes, Funkkanäle</div>
          </div>
        </div>
        <button class="btn btnGhost" id="btnSaveNote">Notiz speichern</button>
      </div>

      <div class="content">
        <div class="field">
          <label>Notizen (Auto-Save)</label>
          <textarea id="txtNotes" placeholder="Einsatznotizen, BOLO, Kennzeichen, Besonderheiten…"></textarea>
          <div class="muted" id="noteStatus" style="margin-top:8px;">—</div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funcodes</h3>
          <div class="codeList" id="funcodeList"></div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funkkanäle</h3>
          <div class="codeList">
            <div class="codeRow"><b>LSPD</b><span>-1</span></div>
            <div class="codeRow"><b>LSMD</b><span>-2</span></div>
            <div class="codeRow"><b>DOJ</b><span>-3</span></div>
            <div class="codeRow"><b>Army</b><span>-6</span></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * 1) CONFIG
     ***********************/
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 2) UI DATA
     ***********************/
    const FUNCODES = [
      ["10-1", "Im Dienst"],
      ["10-2", "Außer Dienst"],
      ["10-4", "Verstanden"],
      ["10-5", "Verstärkung"],
      ["10-6", "Funkspruch wiederholen"],
      ["10-7", "Overwatch benötigt"],
      ["10-15", "TV in Gewahrsam"],
      ["10-33", "Verunfallt"],
      ["10-50", "Verkehrsunfall"],
      ["10-60", "Allgemeine Verkehrskontrolle"],
      ["10-80", "Verfolgungsjagd"],
      ["11-90", "Officers in Bedrängnis"],
      ["11-99", "Officer unter Beschuss"],
      ["10-20", "Positionsabfrage"],
      ["10-22", "Abholung benötigt"],
      ["CODE 0", "Kopfschmerzen"],
      ["CODE 1", "Auf Streife"],
      ["CODE 2", "Anfahrt ohne Sondersignal"],
      ["CODE 3", "Anfahrt mit Sondersignal"],
      ["CODE 4", "Einsatz Ende / unter Kontrolle"],
      ["CODE 7", "Nicht einsatzbereit"],
      ["CODE 99", "Möglicher Hinterhalt"]
    ];

    /***********************
     * 3) DOM
     ***********************/
    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");
    const toastEl = document.getElementById("toast");

    const inpName = document.getElementById("inpName");
    const inpCallsign = document.getElementById("inpCallsign");
    const selPatrol = document.getElementById("selPatrol");

    const btnOn = document.getElementById("btnOn");
    const btnOff = document.getElementById("btnOff");
    const btnRemember = document.getElementById("btnRemember");
    const meHint = document.getElementById("meHint");

    const onDutyList = document.getElementById("onDutyList");
    const onCount = document.getElementById("onCount");

    const patrolGrid = document.getElementById("patrolGrid");
    const btnAddPatrol = document.getElementById("btnAddPatrol");
    const btnRefresh = document.getElementById("btnRefresh");

    const txtNotes = document.getElementById("txtNotes");
    const btnSaveNote = document.getElementById("btnSaveNote");
    const noteStatus = document.getElementById("noteStatus");

    const funcodeList = document.getElementById("funcodeList");

    /***********************
     * 4) STATE
     ***********************/
    let patrols = [];
    let officers = [];
    let noteAutosaveTimer = null;

    /***********************
     * 5) HELPERS
     ***********************/
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1600);
    }

    function setConn(ok){
      connDot.classList.toggle("on", ok);
      connDot.classList.toggle("off", !ok);
      connText.textContent = ok ? "online" : "offline";
    }

    function escapeHtml(s){
      return (s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function groupByPatrol(list){
      const map = new Map();
      for(const o of list){
        const key = o.patrol_id ?? "none";
        if(!map.has(key)) map.set(key, []);
        map.get(key).push(o);
      }
      return map;
    }

    function timeAgo(iso){
      try{
        const t = new Date(iso).getTime();
        const diff = Math.max(0, Date.now() - t);
        const min = Math.floor(diff/60000);
        if(min < 1) return "gerade eben";
        if(min < 60) return `${min} min`;
        const h = Math.floor(min/60);
        return `${h} h`;
      }catch{ return "—"; }
    }

    /***********************
     * 6) RENDER
     ***********************/
    function renderFuncodes(){
      funcodeList.innerHTML = FUNCODES.map(([c, d]) => `
        <div class="codeRow">
          <b>${escapeHtml(c)}</b>
          <span>${escapeHtml(d)}</span>
        </div>
      `).join("");
    }

    function renderPatrolSelect(){
      selPatrol.innerHTML = `
        <option value="">(keine Streife)</option>
        ${patrols.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (#${p.id})</option>`).join("")}
      `;
    }

    function renderOnDuty(){
      const on = officers.filter(o => o.status === "10-1");
      onCount.textContent = on.length;

      if(on.length === 0){
        onDutyList.innerHTML = `<div class="muted">Keine Beamten im Dienst.</div>`;
        return;
      }

      onDutyList.innerHTML = on
        .sort((a,b)=> (a.callsign||"").localeCompare(b.callsign||""))
        .map(o => {
          const patrolName = patrols.find(p => p.id === o.patrol_id)?.name ?? "—";
          return `
            <div class="item">
              <div>
                <strong>${escapeHtml(o.callsign)}</strong>
                <div class="mini">${escapeHtml(o.name)}</div>
                <div class="muted">Streife: ${escapeHtml(patrolName)}</div>
              </div>
              <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                <span class="pill"><span class="dot on"></span>10-1</span>
                <span class="muted">${timeAgo(o.last_seen)}</span>
              </div>
            </div>
          `;
        }).join("");
    }

    function renderPatrolGrid(){
      const byPatrol = groupByPatrol(officers);

      patrolGrid.innerHTML = patrols.map(p => {
        const list = (byPatrol.get(p.id) ?? [])
          .slice()
          .sort((a,b)=> (a.callsign||"").localeCompare(b.callsign||""));

        const lines = list.length
          ? list.map(o => {
              const isOn = o.status === "10-1";
              return `
                <div class="officerLine">
                  <div style="min-width:0;">
                    <div style="display:flex; align-items:center; gap:8px;">
                      <span class="dot ${isOn ? "on":"off"}"></span>
                      <strong>${escapeHtml(o.callsign)}</strong>
                      <span class="pill">${isOn ? "10-1" : "10-2"}</span>
                    </div>
                    <div class="muted" style="margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                      ${escapeHtml(o.name)}
                    </div>
                  </div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn btnGhost" data-act="toggle" data-id="${o.id}">
                      ${isOn ? "10-2" : "10-1"}
                    </button>
                    <button class="btn btnDanger" data-act="remove" data-id="${o.id}">Entfernen</button>
                  </div>
                </div>
              `;
            }).join("")
          : `<div class="muted">Keine Zuweisungen.</div>`;

        return `
          <div class="card">
            <div class="cardHeader">
              <div class="patrolName" style="flex:1;">
                <input value="${escapeHtml(p.name)}" data-act="renamePatrol" data-id="${p.id}" title="Streifenname bearbeiten"/>
              </div>
              <button class="btn btnDanger" data-act="deletePatrol" data-id="${p.id}" title="Streife löschen">✕</button>
            </div>
            <div class="cardBody">
              ${lines}
            </div>
          </div>
        `;
      }).join("");

      // Bind actions
      patrolGrid.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const act = btn.getAttribute("data-act");
          const id = Number(btn.getAttribute("data-id"));
          if(act === "toggle") return toggleOfficerStatus(id);
          if(act === "remove") return deleteOfficer(id);
          if(act === "deletePatrol") return deletePatrol(id);
        });
      });

      patrolGrid.querySelectorAll("input[data-act='renamePatrol']").forEach(inp=>{
        inp.addEventListener("change", async ()=>{
          const id = Number(inp.getAttribute("data-id"));
          const name = inp.value.trim() || "Streife";
          await renamePatrol(id, name);
        });
      });
    }

    /***********************
     * 7) SUPABASE CRUD
     ***********************/
    async function loadAll(){
      // Patrols
      const pRes = await sb.from("patrols").select("*").order("id", {ascending:true});
      if(pRes.error){ setConn(false); throw pRes.error; }
      patrols = pRes.data || [];

      // Officers
      const oRes = await sb.from("officers").select("*").order("id", {ascending:true});
      if(oRes.error){ setConn(false); throw oRes.error; }
      officers = oRes.data || [];

      // Notes
      const nRes = await sb.from("dispatch_notes").select("*").eq("id", 1).single();
      if(nRes.error){ setConn(false); throw nRes.error; }
      txtNotes.value = nRes.data?.content ?? "";

      setConn(true);
      renderPatrolSelect();
      renderOnDuty();
      renderPatrolGrid();
      noteStatus.textContent = `geladen • ${new Date().toLocaleTimeString()}`;
    }

    async function upsertOfficer({name, callsign, patrol_id, status}){
      // "name+callsign" als quasi-Identität: wenn vorhanden -> update, sonst insert
      const existing = officers.find(o => (o.name === name && o.callsign === callsign));
      const payload = {
        name,
        callsign,
        patrol_id: patrol_id ? Number(patrol_id) : null,
        status,
        last_seen: new Date().toISOString()
      };

      if(existing){
        const res = await sb.from("officers").update(payload).eq("id", existing.id).select("*").single();
        if(res.error) throw res.error;
        return res.data;
      }else{
        const res = await sb.from("officers").insert(payload).select("*").single();
        if(res.error) throw res.error;
        return res.data;
      }
    }

    async function toggleOfficerStatus(id){
      const o = officers.find(x => x.id === id);
      if(!o) return;
      const next = (o.status === "10-1") ? "10-2" : "10-1";
      const res = await sb.from("officers")
        .update({ status: next, last_seen: new Date().toISOString() })
        .eq("id", id)
        .select("*")
        .single();
      if(res.error) return toast("Fehler beim Umschalten");
      toast(`Status: ${next}`);
    }

    async function deleteOfficer(id){
      const res = await sb.from("officers").delete().eq("id", id);
      if(res.error) return toast("Fehler beim Entfernen");
      toast("Officer entfernt");
    }

    async function addPatrol(){
      const res = await sb.from("patrols").insert({ name: "Neue Streife" }).select("*").single();
      if(res.error) return toast("Fehler beim Anlegen");
      toast("Streife erstellt");
    }

    async function renamePatrol(id, name){
      const res = await sb.from("patrols").update({ name }).eq("id", id);
      if(res.error) return toast("Fehler beim Umbenennen");
      toast("Streifenname gespeichert");
    }

    async function deletePatrol(id){
      // löscht nur Streife, Officers behalten (patrol_id -> null durch FK on delete set null)
      const res = await sb.from("patrols").delete().eq("id", id);
      if(res.error) return toast("Fehler beim Löschen");
      toast("Streife gelöscht");
    }

    async function saveNote(){
      const content = txtNotes.value ?? "";
      const res = await sb.from("dispatch_notes")
        .update({ content, updated_at: new Date().toISOString() })
        .eq("id", 1);
      if(res.error){
        noteStatus.textContent = "Fehler beim Speichern";
        return;
      }
      noteStatus.textContent = `gespeichert • ${new Date().toLocaleTimeString()}`;
    }

    /***********************
     * 8) REALTIME
     ***********************/
    function setupRealtime(){
      sb.channel("rt-officers")
        .on("postgres_changes", { event:"*", schema:"public", table:"officers" }, payload => {
          // Bei jeder Änderung einfach neu laden (simpel & robust)
          loadAll().catch(()=>{});
        })
        .subscribe();

      sb.channel("rt-patrols")
        .on("postgres_changes", { event:"*", schema:"public", table:"patrols" }, payload => {
          loadAll().catch(()=>{});
        })
        .subscribe();

      sb.channel("rt-notes")
        .on("postgres_changes", { event:"*", schema:"public", table:"dispatch_notes" }, payload => {
          // Notizen nur neu ziehen, wenn nicht gerade tippt (wir überschreiben nicht aggressiv)
          // -> hier simpel: nicht auto-pushen, loadAll macht es beim refresh
        })
        .subscribe();
    }

    /***********************
     * 9) EVENTS
     ***********************/
    btnOn.addEventListener("click", async ()=>{
      const name = inpName.value.trim();
      const callsign = inpCallsign.value.trim();
      const patrol_id = selPatrol.value;

      if(!name || !callsign) return toast("Name & Callsign ausfüllen");
      try{
        await upsertOfficer({ name, callsign, patrol_id, status:"10-1" });
        toast("10-1 gesetzt");
        await loadAll();
      }catch(e){
        console.error(e);
        toast("Fehler: 10-1");
        setConn(false);
      }
    });

    btnOff.addEventListener("click", async ()=>{
      const name = inpName.value.trim();
      const callsign = inpCallsign.value.trim();
      const patrol_id = selPatrol.value;

      if(!name || !callsign) return toast("Name & Callsign ausfüllen");
      try{
        await upsertOfficer({ name, callsign, patrol_id, status:"10-2" });
        toast("10-2 gesetzt");
        await loadAll();
      }catch(e){
        console.error(e);
        toast("Fehler: 10-2");
        setConn(false);
      }
    });

    btnAddPatrol.addEventListener("click", async ()=>{
      await addPatrol();
      await loadAll();
    });

    btnRefresh.addEventListener("click", async ()=>{
      toast("Aktualisiere…");
      await loadAll().catch(()=>{});
    });

    btnSaveNote.addEventListener("click", async ()=>{
      await saveNote();
      toast("Notiz gespeichert");
    });

    txtNotes.addEventListener("input", ()=>{
      noteStatus.textContent = "tippt…";
      if(noteAutosaveTimer) clearTimeout(noteAutosaveTimer);
      noteAutosaveTimer = setTimeout(async ()=>{
        await saveNote();
      }, 900);
    });

    btnRemember.addEventListener("click", ()=>{
      const payload = {
        name: inpName.value.trim(),
        callsign: inpCallsign.value.trim(),
        patrol_id: selPatrol.value
      };
      localStorage.setItem("lspd_me", JSON.stringify(payload));
      meHint.textContent = "gespeichert";
      setTimeout(()=> meHint.textContent = "", 1500);
    });

    function loadRemembered(){
      try{
        const raw = localStorage.getItem("lspd_me");
        if(!raw) return;
        const me = JSON.parse(raw);
        inpName.value = me.name || "";
        inpCallsign.value = me.callsign || "";
        // patrol_id wird nach patrol-load gesetzt
        return me.patrol_id || "";
      }catch{ return ""; }
    }

    /***********************
     * 10) INIT
     ***********************/
    (function init(){
      renderFuncodes();
      setConn(false);

      const rememberedPatrol = loadRemembered();

      loadAll()
        .then(()=>{
          if(rememberedPatrol){
            selPatrol.value = rememberedPatrol;
          }
        })
        .catch((e)=>{
          console.error(e);
          toast("Supabase Verbindung prüfen");
          setConn(false);
        });

      setupRealtime();
    })();
  </script>
</body>
</html>

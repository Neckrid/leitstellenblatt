<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LSPD Leitstelle – Leitstellenblatt</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#fff;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 12% 18%, rgba(0,255,195,0.10), transparent 60%),
        radial-gradient(900px 650px at 88% 72%, rgba(255,70,180,0.08), transparent 62%),
        radial-gradient(760px 520px at 72% 20%, rgba(0,140,255,0.10), transparent 60%),
        linear-gradient(180deg, #05070c, #070a12 40%, #05060b);
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 420px 1fr 360px; /* links breiter */
      gap:14px;
      padding:14px;
    }

    .panel{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(14, 18, 28, 0.55);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{ display:flex; gap:10px; align-items:center; }
    .badge{
      height:38px;
      width:auto;
      min-width:38px;
      padding:0 12px;
      border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.20), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      font-weight:800;
      letter-spacing:0.5px;
      white-space:nowrap;
      font-size:12px;
    }
    .titleWrap{ line-height:1.05; }
    .title{ font-size:14px; font-weight:800; letter-spacing:0.6px; }
    .subtitle{ font-size:12px; opacity:0.75; }

    .content{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    .row{ display:flex; gap:10px; }
    .field{
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px;
    }
    label{ font-size:12px; opacity:0.75; display:block; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:120px; }

    .btn{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.2px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(0,255,195,0.22), rgba(0,140,255,0.18));
      border-color: rgba(0,255,195,0.25);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(255,70,180,0.18), rgba(255,70,70,0.16));
      border-color: rgba(255,70,180,0.25);
    }
    .btnGhost{ background: transparent; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      opacity:0.92;
      white-space:nowrap;
    }

    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }
    .dot.on{ background: rgba(0,255,195,0.95); box-shadow: 0 0 0 3px rgba(0,255,195,0.12), 0 0 18px rgba(0,255,195,0.35); }
    .dot.off{ background: rgba(255,70,180,0.90); box-shadow: 0 0 0 3px rgba(255,70,180,0.12), 0 0 18px rgba(255,70,180,0.28); }

    .muted{ opacity:0.75; font-size:12px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(260px, 1fr));
      gap:14px;
    }

    .card{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.25);
    }
    .cardHeader{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .patrolName{
      font-weight:900;
      letter-spacing:0.4px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .patrolName input{
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.3px;
      min-width: 140px;
    }

    .funcodeSelect{
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.2px;
      width: 190px;
    }

    .cardBody{ padding:12px; }

    .dropZone{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 52px;
    }

    .officerLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }

    .dragHandle{
      cursor:grab;
      user-select:none;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-weight:900;
      opacity:0.9;
    }
    .dragHandle:active{ cursor:grabbing; }

    .rightBox h3{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:0.6px;
      opacity:0.9;
    }
    .codeList{ display:flex; flex-direction:column; gap:8px; }
    .codeRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .codeRow b{ font-size:12px; white-space:nowrap; }
    .codeRow span{ font-size:12px; opacity:0.82; }

    .topActions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(10,12,18,0.72);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size:13px;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }

    @media (max-width: 1200px){
      body{ overflow:auto; }
      .app{ height:auto; grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">LSPD</div>
          <div class="titleWrap">
            <div class="title">LEITSTELLE</div>
            <div class="subtitle">Dienst & Streifenverwaltung</div>
          </div>
        </div>
        <span class="pill"><span class="dot off" id="connDot"></span><span id="connText">offline</span></span>
      </div>

      <div class="content">
        <div class="field">
          <label>Beamter erstellen</label>
          <input id="inpName" placeholder="Name (z.B. John Doe)"/>

          <div style="height:10px"></div>
          <label>Dienstnummer</label>
          <input id="inpDienstnr" placeholder="z.B. 4711"/>

          <div style="height:12px"></div>
          <div class="row">
            <button class="btn btnPrimary" id="btnCreateOfficer">Beamter erstellen</button>
            <button class="btn btnGhost" id="btnRemember">Eingaben merken</button>
          </div>

          <div style="height:10px"></div>
          <div class="row" style="align-items:center;">
            <span class="muted" id="meHint"></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <label style="margin:0;">Erstellte Beamte (Pool)</label>
            <span class="pill"><span class="dot on"></span><span id="createdCount">0</span></span>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <input id="inpSearch" placeholder="Suche (Name oder DN)"/>
          </div>

          <div style="height:10px"></div>

          <div class="dropZone" id="createdList" data-dropzone="1" data-patrol-id=""></div>
        </div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">10</div>
          <div class="titleWrap">
            <div class="title">STREIFENEINTEILUNG</div>
            <div class="subtitle">Drag & Drop • Funkcode pro Streife • Live Sync</div>
          </div>
        </div>
        <div class="topActions">
          <button class="btn" id="btnAddPatrol">+ Streife</button>
          <button class="btn btnGhost" id="btnReload">Neu laden</button>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="patrolGrid"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel">
      <div class="panelHeader">
        <div class="brand">
          <div class="badge">⟡</div>
          <div class="titleWrap">
            <div class="title">LEITSTELLEN-TOOLS</div>
            <div class="subtitle">Notizen, Funcodes, Funkkanäle</div>
          </div>
        </div>
        <button class="btn btnGhost" id="btnSaveNote">Notiz speichern</button>
      </div>

      <div class="content">
        <div class="field">
          <label>Notizen (Auto-Save)</label>
          <textarea id="txtNotes" placeholder="Einsatznotizen, BOLO, Kennzeichen, Besonderheiten…"></textarea>
          <div class="muted" id="noteStatus" style="margin-top:8px;">—</div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funcodes</h3>
          <div class="codeList" id="funcodeList"></div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funkkanäle</h3>
          <div class="codeList">
            <div class="codeRow"><b>LSPD</b><span>-1</span></div>
            <div class="codeRow"><b>LSMD</b><span>-2</span></div>
            <div class="codeRow"><b>DOJ</b><span>-3</span></div>
            <div class="codeRow"><b>Army</b><span>-6</span></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const SUPABASE_URL = "https://vuowfnmavgfkvabdtelx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1b3dmbm1hdmdma3ZhYmR0ZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTM1MjQsImV4cCI6MjA4Nzg2OTUyNH0.R-oI8UzrP_ovDePN11wN2zFDifERkMOHZfNckjHLwhg";

    // ✅ explizit connect + stabileres Realtime-Verhalten
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: { params: { eventsPerSecond: 10 } }
    });

    /***********************
     * DATA
     ***********************/
    const FUNCODES = [
      ["10-1", "Im Dienst"], ["10-2", "Außer Dienst"], ["10-4", "Verstanden"], ["10-5", "Verstärkung"],
      ["10-6", "Funkspruch wiederholen"], ["10-7", "Overwatch benötigt"], ["10-15", "TV in Gewahrsam"],
      ["10-33", "Verunfallt"], ["10-50", "Verkehrsunfall"], ["10-60", "Allgemeine Verkehrskontrolle"],
      ["10-80", "Verfolgungsjagd"], ["11-90", "Officers in Bedrängnis"], ["11-99", "Officer unter Beschuss"],
      ["10-20", "Positionsabfrage"], ["10-22", "Abholung benötigt"], ["CODE 0", "Kopfschmerzen"],
      ["CODE 1", "Auf Streife"], ["CODE 2", "Anfahrt ohne Sondersignal"], ["CODE 3", "Anfahrt mit Sondersignal"],
      ["CODE 4", "Einsatz Ende / unter Kontrolle"], ["CODE 7", "Nicht einsatzbereit"], ["CODE 99", "Möglicher Hinterhalt"]
    ];

    function escapeHtml(s){
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function funcodeOptionsHtml(selected){
      return FUNCODES.map(([c,d])=>{
        const label = `${c} – ${d}`;
        const sel = (selected === c) ? "selected" : "";
        return `<option value="${escapeHtml(c)}" ${sel}>${escapeHtml(label)}</option>`;
      }).join("");
    }
    function funcodeLabel(code){
      const found = FUNCODES.find(x => x[0] === code);
      return found ? `${found[0]} – ${found[1]}` : code;
    }

    /***********************
     * DOM
     ***********************/
    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");
    const toastEl = document.getElementById("toast");

    const inpName = document.getElementById("inpName");
    const inpDienstnr = document.getElementById("inpDienstnr");

    const btnCreateOfficer = document.getElementById("btnCreateOfficer");
    const btnRemember = document.getElementById("btnRemember");
    const meHint = document.getElementById("meHint");

    const inpSearch = document.getElementById("inpSearch");
    const createdList = document.getElementById("createdList");
    const createdCount = document.getElementById("createdCount");

    const patrolGrid = document.getElementById("patrolGrid");
    const btnAddPatrol = document.getElementById("btnAddPatrol");
    const btnReload = document.getElementById("btnReload");

    const txtNotes = document.getElementById("txtNotes");
    const btnSaveNote = document.getElementById("btnSaveNote");
    const noteStatus = document.getElementById("noteStatus");

    const funcodeList = document.getElementById("funcodeList");

    /***********************
     * STATE
     ***********************/
    let patrols = [];
    let officers = [];
    let noteAutosaveTimer = null;
    let sortables = [];

    // ✅ Realtime Channels (für Resubscribe)
    let rtChannels = [];
    let rtResubTimer = null;

    /***********************
     * UI HELPERS
     ***********************/
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1800);
    }
    function setConn(ok){
      connDot.classList.toggle("on", ok);
      connDot.classList.toggle("off", !ok);
      connText.textContent = ok ? "online" : "offline";
    }
    function timeAgo(iso){
      try{
        const t = new Date(iso).getTime();
        const diff = Math.max(0, Date.now() - t);
        const min = Math.floor(diff/60000);
        if(min < 1) return "gerade eben";
        if(min < 60) return `${min} min`;
        const h = Math.floor(min/60);
        return `${h} h`;
      }catch{ return "—"; }
    }
    function upsertLocal(arr, row){
      const i = arr.findIndex(x => x.id === row.id);
      if(i >= 0) arr[i] = row;
      else arr.push(row);
    }

    /***********************
     * RENDER ALL
     ***********************/
    function renderAll(){
      renderCreatedPool();
      renderPatrolGrid();
    }

    /***********************
     * RENDER
     ***********************/
    function renderFuncodes(){
      funcodeList.innerHTML = FUNCODES.map(([c, d]) => `
        <div class="codeRow"><b>${escapeHtml(c)}</b><span>${escapeHtml(d)}</span></div>
      `).join("");
    }

    function matchesSearch(officer, q){
      if(!q) return true;
      const name = (officer.name ?? "").toString().toLowerCase();
      const dn = (officer.dienstnummer ?? "").toString().toLowerCase();
      return name.includes(q) || dn.includes(q);
    }

    function renderCreatedPool(){
      const q = (inpSearch.value ?? "").trim().toLowerCase();
      let pool = officers.filter(o => o.patrol_id == null);
      if(q) pool = pool.filter(o => matchesSearch(o, q));

      createdCount.textContent = pool.length;

      if(pool.length === 0){
        createdList.innerHTML = `<div class="muted">Keine Treffer im Pool.</div>`;
        return;
      }

      createdList.innerHTML = pool
        .slice()
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""))
        .map(o => {
          const isOn = o.status === "10-1";
          const dn = o.dienstnummer ? `DN ${o.dienstnummer}` : "DN —";

          return `
            <div class="officerLine" data-officer-id="${o.id}">
              <div style="display:flex; gap:10px; align-items:flex-start; min-width:0; flex:1;">
                <div class="dragHandle" title="Ziehen">≡</div>

                <div style="min-width:0; flex:1;">
                  <!-- ✅ Name-Zeile -->
                  <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                    <span class="dot ${isOn ? "on":"off"}"></span>
                    <strong style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                      ${escapeHtml(o.name)}
                    </strong>
                    <!-- ✅ 10-1 anzeigen, 10-2 NICHT -->
                    ${isOn ? `<span class="pill">10-1</span>` : ``}
                  </div>

                  <!-- ✅ Dienstnummer IMMER darunter -->
                  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  <span class="pill">${escapeHtml(dn)}</span>
                  </div>

                  <div class="muted" style="margin-top:6px;">zuletzt: ${escapeHtml(timeAgo(o.last_seen))}</div>
                </div>
                </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn btnDanger" data-act="remove" data-id="${o.id}">Löschen</button>
              </div>
            </div>
          `;
        }).join("");

      createdList.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          const id = Number(btn.getAttribute("data-id"));
          if(act === "remove") return deleteOfficer(id);
        });
      });
    }

    function renderPatrolGrid(){
      for(const s of sortables){ try{s.destroy();}catch{} }
      sortables = [];

      const sortedPatrols = patrols.slice().sort((a,b)=>a.id-b.id);

      patrolGrid.innerHTML = sortedPatrols.map(p => {
        const list = officers
          .filter(o => o.patrol_id === p.id)
          .slice()
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

        const code = p.funcode || "CODE 1";

        const lines = list.length
          ? list.map(o => {
              const dn = o.dienstnummer ? `DN ${o.dienstnummer}` : "DN —";
              return `
                <div class="officerLine" data-officer-id="${o.id}">
                  <div style="display:flex; gap:10px; align-items:center; min-width:0;">
                    <div class="dragHandle" title="Ziehen">≡</div>
                    <div style="min-width:0;">
                      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <span class="dot ${o.status === "10-1" ? "on":"off"}"></span>
                        <strong>${escapeHtml(o.name)}</strong>
                        <span class="pill">${escapeHtml(dn)}</span>
                      </div>
                      <div class="muted" style="margin-top:4px;">${escapeHtml(funcodeLabel(code))}</div>
                    </div>
                  </div>

                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn" data-act="backToPool" data-id="${o.id}">Zurück in Pool</button>
                  </div>
                </div>
              `;
            }).join("")
          : `<div class="muted">Ziehe Beamte hierher…</div>`;

        return `
          <div class="card" data-patrol-card="${p.id}">
            <div class="cardHeader">
              <div class="patrolName">
                <input value="${escapeHtml(p.name)}" data-act="renamePatrol" data-id="${p.id}" title="Streifenname bearbeiten"/>
              </div>

              <select class="funcodeSelect" data-act="patrolFuncode" data-id="${p.id}" title="Funkcode wählen">
                ${funcodeOptionsHtml(code)}
              </select>

              <button class="btn btnDanger" data-act="deletePatrol" data-id="${p.id}" title="Streife löschen">✕</button>
            </div>

            <div class="cardBody">
              <div class="pill" title="Aktueller Funkcode"><b style="opacity:.9;">Funkcode:</b> ${escapeHtml(funcodeLabel(code))}</div>
              <div style="height:10px"></div>

              <div class="dropZone" data-dropzone="1" data-patrol-id="${p.id}">
                ${lines}
              </div>
            </div>
          </div>
        `;
      }).join("");

      patrolGrid.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          const id = Number(btn.getAttribute("data-id"));
          if(act === "deletePatrol") return deletePatrol(id);
          if(act === "backToPool") return moveOfficerToPatrolAndMaybeStatus(id, null, "10-2");
        });
      });

      patrolGrid.querySelectorAll("input[data-act='renamePatrol']").forEach(inp=>{
        inp.addEventListener("change", async ()=>{
          const id = Number(inp.getAttribute("data-id"));
          const name = inp.value.trim() || "Streife";
          await renamePatrol(id, name);
        });
      });

      patrolGrid.querySelectorAll("select[data-act='patrolFuncode']").forEach(sel=>{
        sel.addEventListener("change", async ()=>{
          const id = Number(sel.getAttribute("data-id"));
          const funcode = sel.value;
          await updatePatrolFuncode(id, funcode);
        });
      });

      initDragAndDrop();
    }

    function initDragAndDrop(){
      const zones = document.querySelectorAll(".dropZone[data-dropzone='1']");
      zones.forEach(zone=>{
        const sortable = new Sortable(zone, {
          group: "officers-shared",
          animation: 150,
          handle: ".dragHandle",
          onEnd: async (evt) => {
            const item = evt.item;
            const officerId = Number(item.getAttribute("data-officer-id"));
            const toZone = evt.to;
            const raw = toZone.getAttribute("data-patrol-id"); // "" => Pool
            const toPatrolId = (raw === "" || raw == null) ? null : Number(raw);

            const o = officers.find(x => x.id === officerId);
            if(!o) return;

            const same = (o.patrol_id == null && toPatrolId == null) || (o.patrol_id === toPatrolId);
            if(same) return;

            const autoStatus = (toPatrolId == null) ? "10-2" : "10-1";
            await moveOfficerToPatrolAndMaybeStatus(officerId, toPatrolId, autoStatus);
          }
        });
        sortables.push(sortable);
      });
    }

    /***********************
     * CRUD
     ***********************/
    async function loadAll(){
      const pRes = await sb.from("patrols").select("*").order("id", {ascending:true});
      if(pRes.error){ setConn(false); throw pRes.error; }
      patrols = pRes.data || [];

      const oRes = await sb.from("officers").select("*").order("id", {ascending:true});
      if(oRes.error){ setConn(false); throw oRes.error; }
      officers = oRes.data || [];

      const nRes = await sb.from("dispatch_notes").select("*").eq("id", 1).single();
      if(nRes.error){ setConn(false); throw nRes.error; }
      txtNotes.value = nRes.data?.content ?? "";

      renderAll();
      noteStatus.textContent = `geladen • ${new Date().toLocaleTimeString()}`;
    }

    function findOfficerIdentity(name, dienstnummer){
      const dn = (dienstnummer ?? "").trim();
      if(dn) return officers.find(o => (o.dienstnummer ?? "").toString().trim() === dn);
      return officers.find(o => o.name === name);
    }

    async function upsertOfficer({name, dienstnummer, patrol_id, status}){
      const existing = findOfficerIdentity(name, dienstnummer);
      const payload = {
        name,
        dienstnummer: (dienstnummer ?? "").trim() || null,
        patrol_id: (patrol_id === "" || patrol_id == null) ? null : Number(patrol_id),
        status,
        last_seen: new Date().toISOString()
      };

      if(existing){
        const optimistic = { ...existing, ...payload, id: existing.id };
        officers = officers.map(o => o.id === existing.id ? optimistic : o);
        renderAll();

        const res = await sb.from("officers").update(payload).eq("id", existing.id).select("*").single();
        if(res.error) throw res.error;
        upsertLocal(officers, res.data);
        renderAll();
        return res.data;
      }else{
        const res = await sb.from("officers").insert(payload).select("*").single();
        if(res.error) throw res.error;
        upsertLocal(officers, res.data);
        renderAll();
        return res.data;
      }
    }

    async function createOfficer(){
      const name = inpName.value.trim();
      const dienstnummer = inpDienstnr.value.trim();
      if(!name) return toast("Name ausfüllen");
      if(!dienstnummer) return toast("Dienstnummer ausfüllen");

      try{
        // Standard: neu im Pool mit 10-2
        await upsertOfficer({ name, dienstnummer, patrol_id: null, status: "10-2" });
        toast("Beamter erstellt");
      }catch(e){
        console.error(e);
        toast("Fehler: " + (e?.message || "create"));
        setConn(false);
      }
    }

    async function moveOfficerToPatrolAndMaybeStatus(officerId, toPatrolId, status){
      const o = officers.find(x => x.id === officerId);
      if(!o) return;

      const before = { ...o };
      const optimistic = {
        ...o,
        patrol_id: (toPatrolId == null ? null : Number(toPatrolId)),
        status: status ?? o.status,
        last_seen: new Date().toISOString()
      };

      officers = officers.map(x => x.id === officerId ? optimistic : x);
      renderAll();

      const res = await sb.from("officers")
        .update({ patrol_id: optimistic.patrol_id, status: optimistic.status, last_seen: optimistic.last_seen })
        .eq("id", officerId)
        .select("*")
        .single();

      if(res.error){
        console.error("moveOfficerToPatrol error:", res.error);
        toast("Fehler Verschieben: " + (res.error.message || "unknown"));
        officers = officers.map(x => x.id === officerId ? before : x);
        renderAll();
        return;
      }

      upsertLocal(officers, res.data);
      renderAll();

      if(toPatrolId == null) toast("In Pool");
      else toast("Auf Streife");
    }

    async function deleteOfficer(id){
      const before = officers.slice();
      officers = officers.filter(o => o.id !== id);
      renderAll();

      const res = await sb.from("officers").delete().eq("id", id);
      if(res.error){
        console.error("deleteOfficer error:", res.error);
        toast("Fehler Löschen: " + (res.error.message || "unknown"));
        officers = before;
        renderAll();
        return;
      }
      toast("Officer gelöscht");
    }

    async function addPatrol(){
      const res = await sb.from("patrols").insert({ name: "Neue Streife", funcode: "CODE 1" }).select("*").single();
      if(res.error){ console.error("addPatrol error:", res.error); toast("Fehler +Streife: " + (res.error.message || "unknown")); return; }
      upsertLocal(patrols, res.data);
      patrols.sort((a,b)=>a.id-b.id);
      renderAll();
      toast("Streife erstellt");
    }

    async function renamePatrol(id, name){
      const p = patrols.find(x => x.id === id);
      if(!p) return;

      const before = { ...p };
      patrols = patrols.map(x => x.id === id ? { ...x, name } : x);
      renderAll();

      const res = await sb.from("patrols").update({ name }).eq("id", id).select("*").single();
      if(res.error){
        console.error("renamePatrol error:", res.error);
        toast("Fehler Name: " + (res.error.message || "unknown"));
        patrols = patrols.map(x => x.id === id ? before : x);
        renderAll();
        return;
      }
      upsertLocal(patrols, res.data);
      renderAll();
      toast("Streifenname gespeichert");
    }

    async function updatePatrolFuncode(id, funcode){
      const p = patrols.find(x => x.id === id);
      if(!p) return;

      const before = { ...p };
      patrols = patrols.map(x => x.id === id ? { ...x, funcode } : x);
      renderAll();

      const res = await sb.from("patrols").update({ funcode }).eq("id", id).select("*").single();
      if(res.error){
        console.error("updatePatrolFuncode error:", res.error);
        toast("Fehler Funkcode: " + (res.error.message || "unknown"));
        patrols = patrols.map(x => x.id === id ? before : x);
        renderAll();
        return;
      }
      upsertLocal(patrols, res.data);
      renderAll();
      toast("Funkcode gespeichert");
    }

    async function deletePatrol(id){
      const beforePatrols = patrols.slice();
      const beforeOfficers = officers.slice();

      patrols = patrols.filter(p => p.id !== id);
      officers = officers.map(o => (o.patrol_id === id ? { ...o, patrol_id: null } : o));
      renderAll();

      const res = await sb.from("patrols").delete().eq("id", id);
      if(res.error){
        console.error("deletePatrol error:", res.error);
        toast("Fehler Löschen: " + (res.error.message || "unknown"));
        patrols = beforePatrols;
        officers = beforeOfficers;
        renderAll();
        return;
      }
      toast("Streife gelöscht");
    }

    async function saveNote(){
      const content = txtNotes.value ?? "";
      const res = await sb.from("dispatch_notes")
        .update({ content, updated_at: new Date().toISOString() })
        .eq("id", 1);

      if(res.error){
        console.error("saveNote error:", res.error);
        noteStatus.textContent = "Fehler beim Speichern";
        return;
      }
      noteStatus.textContent = `gespeichert • ${new Date().toLocaleTimeString()}`;
    }

    /***********************
     * REALTIME (LIVE UPDATES)
     ***********************/
    function teardownRealtime(){
      try{
        rtChannels.forEach(ch => { try{ sb.removeChannel(ch); }catch{} });
      }catch{}
      rtChannels = [];
    }

    function scheduleResubscribe(){
      if(rtResubTimer) clearTimeout(rtResubTimer);
      rtResubTimer = setTimeout(() => {
        try{
          teardownRealtime();
          setupRealtime();
        }catch{}
      }, 400);
    }

    function setupRealtime(){
      // Wichtig: connect + frische Subscriptions
      try{ sb.realtime.connect(); }catch{}

      teardownRealtime();

      const chOfficers = sb.channel("rt-officers")
        .on("postgres_changes", { event:"*", schema:"public", table:"officers" }, (payload) => {
          // INSERT/UPDATE -> upsert, DELETE -> entfernen
          if(payload.eventType === "DELETE"){
            const id = payload.old?.id;
            officers = officers.filter(o => o.id !== id);
          }else{
            upsertLocal(officers, payload.new);
          }
          renderAll();
          setConn(true);
        })
        .subscribe((status) => {
          // status: SUBSCRIBED / CHANNEL_ERROR / TIMED_OUT / CLOSED
          if(status === "SUBSCRIBED") setConn(true);
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            setConn(false);
            scheduleResubscribe();
          }
        });

      const chPatrols = sb.channel("rt-patrols")
        .on("postgres_changes", { event:"*", schema:"public", table:"patrols" }, (payload) => {
          if(payload.eventType === "DELETE"){
            const id = payload.old?.id;
            patrols = patrols.filter(p => p.id !== id);
            officers = officers.map(o => (o.patrol_id === id ? { ...o, patrol_id: null } : o));
          }else{
            upsertLocal(patrols, payload.new);
            patrols.sort((a,b)=>a.id-b.id);
          }
          renderAll();
          setConn(true);
        })
        .subscribe((status) => {
          if(status === "SUBSCRIBED") setConn(true);
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            setConn(false);
            scheduleResubscribe();
          }
        });

      const chNotes = sb.channel("rt-notes")
        .on("postgres_changes", { event:"UPDATE", schema:"public", table:"dispatch_notes" }, (payload) => {
          const next = payload.new?.content ?? "";
          if (document.activeElement !== txtNotes) {
            txtNotes.value = next;
            noteStatus.textContent = `aktualisiert • ${new Date().toLocaleTimeString()}`;
          }
          setConn(true);
        })
        .subscribe((status) => {
          if(status === "SUBSCRIBED") setConn(true);
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            setConn(false);
            scheduleResubscribe();
          }
        });

      rtChannels.push(chOfficers, chPatrols, chNotes);
    }

    // Resubscribe wenn Tab wieder aktiv / Internet zurück
    document.addEventListener("visibilitychange", () => {
      if(!document.hidden) scheduleResubscribe();
    });
    window.addEventListener("online", scheduleResubscribe);

    /***********************
     * EVENTS
     ***********************/
    btnCreateOfficer.addEventListener("click", createOfficer);
    inpSearch.addEventListener("input", renderCreatedPool);

    btnAddPatrol.addEventListener("click", addPatrol);
    btnReload.addEventListener("click", async ()=>{ toast("Neu laden…"); await loadAll().catch(()=>{}); });

    btnSaveNote.addEventListener("click", async ()=>{ await saveNote(); toast("Notiz gespeichert"); });

    txtNotes.addEventListener("input", ()=>{
      noteStatus.textContent = "tippt…";
      if(noteAutosaveTimer) clearTimeout(noteAutosaveTimer);
      noteAutosaveTimer = setTimeout(async ()=>{ await saveNote(); }, 900);
    });

    btnRemember.addEventListener("click", ()=>{
      const payload = { name: inpName.value.trim(), dienstnummer: inpDienstnr.value.trim() };
      localStorage.setItem("lspd_me", JSON.stringify(payload));
      meHint.textContent = "gespeichert";
      setTimeout(()=> meHint.textContent = "", 1500);
    });

    function loadRemembered(){
      try{
        const raw = localStorage.getItem("lspd_me");
        if(!raw) return;
        const me = JSON.parse(raw);
        inpName.value = me.name || "";
        inpDienstnr.value = me.dienstnummer || "";
      }catch{}
    }

    /***********************
     * INIT
     ***********************/
    (function init(){
      renderFuncodes();
      setConn(false);

      loadRemembered();

      loadAll()
        .then(()=> setConn(true))
        .catch((e)=>{
          console.error(e);
          toast("Supabase/RLS prüfen: " + (e?.message || "unknown"));
          setConn(false);
        });

      setupRealtime();
    })();
  </script>
</body>
</html>

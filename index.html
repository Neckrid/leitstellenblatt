<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LSPD Leitstelle – Leitstellenblatt</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color:#fff;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 12% 18%, rgba(0,255,195,0.10), transparent 60%),
        radial-gradient(900px 650px at 88% 72%, rgba(255,70,180,0.08), transparent 62%),
        radial-gradient(760px 520px at 72% 20%, rgba(0,140,255,0.10), transparent 60%),
        linear-gradient(180deg, #05070c, #070a12 40%, #05060b);
    }

    /* ========= LOGIN OVERLAY ========= */
    .loginOverlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
      background:
        radial-gradient(900px 600px at 18% 22%, rgba(0,255,195,0.12), transparent 60%),
        radial-gradient(800px 520px at 82% 72%, rgba(255,70,180,0.10), transparent 62%),
        radial-gradient(700px 480px at 70% 18%, rgba(0,140,255,0.10), transparent 60%),
        rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
    }
    .loginCard{
      width:min(560px, 100%);
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(14, 18, 28, 0.70);
      backdrop-filter: blur(12px);
      border-radius:22px;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .loginHeader{
      padding:16px 16px 14px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .loginTitleWrap{ line-height:1.1; min-width:0; }
    .loginTitle{ font-size:14px; font-weight:900; letter-spacing:0.6px; }
    .loginSub{ font-size:12px; opacity:0.78; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .loginBody{ padding:16px; }
    .loginErr{ font-size:12px; color: rgba(255,120,120,0.95); margin-top:10px; display:none; }

    /* ========= APP GRID (collapsible left/right) ========= */
    .app{
      height:100%;
      display:grid;
      gap:14px;
      padding:14px;
      grid-template-columns: var(--leftW, 420px) 1fr var(--rightW, 360px);
      transition: grid-template-columns .25s ease;
    }
    .app.leftCollapsed{ --leftW: 0px; }
    .app.rightCollapsed{ --rightW: 0px; }

    .panel{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(14, 18, 28, 0.55);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      min-width:0;
      position:relative;
    }

    /* Panels collapse animation */
    .panel.collapseX{
      transition: opacity .18s ease, transform .25s ease;
    }
    .app.leftCollapsed #panelLeft{
      opacity:0;
      transform: translateX(-10px);
      pointer-events:none;
    }
    .app.rightCollapsed #panelRight{
      opacity:0;
      transform: translateX(10px);
      pointer-events:none;
    }

    .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }

    /* ✅ Platz für Dock-Button reservieren (verhindert Überlappung) */
    #panelLeft .panelHeader{ padding-right:56px; }
    #panelRight .panelHeader{ padding-left:56px; }

    /* ✅ Center-Header nach innen schieben (verhindert Overlap mit Edge-Buttons) */
    #panelCenter .panelHeader{
      padding-left: 60px;
      padding-right: 60px;
    }

    .brand{ display:flex; gap:10px; align-items:center; min-width:0; }
    .badge{
      height:38px;
      width:auto;
      min-width:38px;
      padding:0 12px;
      border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.20), rgba(255,255,255,0.05));
      border:1px solid rgba(255,255,255,0.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      font-weight:800;
      letter-spacing:0.5px;
      white-space:nowrap;
      font-size:12px;
      flex:0 0 auto;
    }
    .titleWrap{ line-height:1.05; min-width:0; }
    .title{ font-size:14px; font-weight:800; letter-spacing:0.6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .subtitle{ font-size:12px; opacity:0.75; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .content{
      padding:14px;
      overflow:auto;
      min-height:0;
    }

    .row{ display:flex; gap:10px; }
    .field{
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:10px;
    }
    label{ font-size:12px; opacity:0.75; display:block; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:120px; }

    .btn{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.2px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.12); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(0,255,195,0.22), rgba(0,140,255,0.18));
      border-color: rgba(0,255,195,0.25);
    }
    .btnDanger{
      background: linear-gradient(135deg, rgba(255,70,180,0.18), rgba(255,70,70,0.16));
      border-color: rgba(255,70,180,0.25);
    }
    .btnGhost{ background: transparent; }

    /* ✅ Logout: gleiches Style, aber rot */
    .btnLogoutRed{
      background: linear-gradient(135deg, rgba(255,70,70,0.18), rgba(255,70,180,0.14));
      border-color: rgba(255,70,70,0.28);
    }
    .btnLogoutRed:hover{ background: linear-gradient(135deg, rgba(255,70,70,0.24), rgba(255,70,180,0.18)); }

    /* ✅ breiter "+ Streife" */
    .btnWide{
      padding-left:18px;
      padding-right:18px;
      min-width: 160px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      opacity:0.92;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
      flex:0 0 auto;
    }
    .dot.on{ background: rgba(0,255,195,0.95); box-shadow: 0 0 0 3px rgba(0,255,195,0.12), 0 0 18px rgba(0,255,195,0.35); }
    .dot.off{ background: rgba(255,70,180,0.90); box-shadow: 0 0 0 3px rgba(255,70,180,0.12), 0 0 18px rgba(255,70,180,0.28); }
    .dot.red{ background: rgba(255,70,70,0.95); box-shadow: 0 0 0 3px rgba(255,70,70,0.14), 0 0 18px rgba(255,70,70,0.30); }

    .muted{ opacity:0.75; font-size:12px; }

    /* ✅ 3 Streifen nebeneinander + responsive fallback */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
      gap:14px;
    }
    @media (max-width: 1500px){
      .grid{ grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,0.25);
      min-width:0;
    }

    /* Header wrap fix */
    .cardHeader{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .patrolDrag{
      cursor:grab;
      user-select:none;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-weight:900;
      opacity:0.9;
      line-height:1;
    }
    .patrolDrag:active{ cursor:grabbing; }

    .patrolName{
      font-weight:900;
      letter-spacing:0.4px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:180px;
      flex: 1 1 180px;
    }
    .patrolName input{
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.3px;
      width:100%;
      min-width:0;
    }

    .statusSelect{
      padding:8px 10px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.2px;
      width:auto;
      flex: 0 1 220px;
      min-width:160px;
    }
    @media (max-width: 900px){
      .statusSelect{ flex: 1 1 100%; }
    }

    .cardBody{ padding:12px; }

    .dropZone{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height: 52px;
  padding:14px 0;
}

    .officerLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      transition: border-color .15s ease, background .15s ease, transform .08s ease;
    }
    .officerLine.clickable{ cursor:pointer; }
    .officerLine.selected{
      border-color: rgba(0,255,195,0.35);
      background: rgba(0,255,195,0.07);
    }

    .dragHandle{
      cursor:grab;
      user-select:none;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      font-weight:900;
      opacity:0.9;
    }
    .dragHandle:active{ cursor:grabbing; }

    .rightBox h3{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:0.6px;
      opacity:0.9;
    }
    .codeList{ display:flex; flex-direction:column; gap:8px; }
    .codeRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .codeRow b{ font-size:12px; white-space:nowrap; }
    .codeRow span{ font-size:12px; opacity:0.82; }

    .topActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(10,12,18,0.72);
      backdrop-filter: blur(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size:13px;
      z-index:998;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-2px); }

    /* Delete Buttons Hover */
    .officerLine .btnDanger{
      opacity:0;
      pointer-events:none;
      transform: translateY(-1px);
    }
    .officerLine:hover .btnDanger{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }

    /* ✅ Zurück-in-Pool Button nur bei Hover anzeigen */
    .officerLine .btnBack{
      opacity:0;
      pointer-events:none;
      transform: translateY(-1px);
    }
    .officerLine:hover .btnBack{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }

    .cardHeader .btnDanger{
      opacity:0;
      pointer-events:none;
      transform: translateY(-1px);
    }
    .card:hover .cardHeader .btnDanger{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }

    /* Sortable states */
    .sortable-ghost{ opacity:0.35; filter: saturate(0.8); }
    .sortable-chosen{ cursor:grabbing; }

    /* ========= Dock / Toggle Buttons ========= */
    .dockBtn{
      position:absolute;
      top:12px;
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      transition: transform .08s ease, background .2s ease, opacity .2s ease;
      z-index:5;
    }
    .dockBtn:hover{ background: rgba(255,255,255,0.12); }
    .dockBtn:active{ transform: translateY(1px); }

    /* ✅ Buttons nach innen, keine Überlappung */
    #btnToggleLeft{ right:12px; }
    #btnToggleRight{ left:12px; }

    /* When collapsed, show edge buttons fixed on screen so user can reopen */
    .edgeBtn{
      position:fixed;
      top:22px;
      width:36px;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      z-index:50;
      transition: background .2s ease, transform .08s ease;
    }
    .edgeBtn:hover{ background: rgba(255,255,255,0.12); }
    .edgeBtn:active{ transform: translateY(1px); }

    #edgeLeft{ left:10px; }
    #edgeRight{ right:10px; }

    .app.leftCollapsed ~ #edgeLeft{ display:flex; }
    .app.rightCollapsed ~ #edgeRight{ display:flex; }

    @media (max-width: 1200px){
      body{ overflow:auto; }
      .app{ height:auto; grid-template-columns: 1fr; }
      #btnToggleLeft, #btnToggleRight{ display:none; }
      .edgeBtn{ top:10px; }
      #panelCenter .panelHeader{ padding-left:14px; padding-right:14px; }
    }

    /* ========= Collapsible "Beamter erstellen" ========= */
    .collapseCard{ padding:0; overflow:hidden; }
    .collapseHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      cursor:pointer;
      user-select:none;
    }
    .collapseHead .collapseTitle{
      font-size:12px;
      opacity:0.85;
      font-weight:800;
      letter-spacing:0.4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chev{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      transition: transform .18s ease, background .2s ease;
      flex:0 0 auto;
    }
    .collapseHead:hover .chev{ background: rgba(255,255,255,0.10); }

    .collapseBody{
      padding:0 10px 10px 10px;
      transform-origin: top;
      transition: max-height .22s ease, opacity .18s ease, transform .22s ease;
      max-height: 420px;
      opacity:1;
      transform: translateY(0);
    }
    .collapsedUp .collapseBody{
      max-height:0px;
      opacity:0;
      transform: translateY(-6px);
      padding-bottom:0;
    }
    .collapsedUp .chev{ transform: rotate(-90deg); }
  </style>
</head>

<body>
  <!-- ✅ LOGIN (Supabase Auth: User werden von dir vorab erstellt) -->
  <div class="loginOverlay" id="loginOverlay" style="display:none;">
    <div class="loginCard">
      <div class="loginHeader">
        <div class="brand">
          <div class="badge">LSPD</div>
          <div class="loginTitleWrap">
            <div class="loginTitle">LOGIN</div>
            <div class="loginSub">Bitte anmelden</div>
          </div>
        </div>
      </div>

      <div class="loginBody">
        <label>Name</label>
        <input id="inpLoginName" placeholder="Name" autocomplete="username" />

        <div style="height:10px"></div>

        <label>Passwort</label>
        <input id="inpLoginPw" type="password" placeholder="Passwort" autocomplete="current-password" />

        <div class="loginErr" id="loginErr">—</div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn btnPrimary" id="btnLogin">Login</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app" id="app" style="display:none;">
    <!-- LEFT -->
    <section class="panel collapseX" id="panelLeft">
      <div class="dockBtn" id="btnToggleLeft" title="Links ein/aus">❮</div>

      <div class="panelHeader">
        <!-- ✅ LEITSTELLE + Subtitle entfernt (nur Badge bleibt) -->
        <div class="brand">
          <div class="badge">LSPD</div>
        </div>

        <!-- ✅ Punkt + Text "Leitstelle" + Logout -->
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="pill" title="Realtime Verbindung">
            <span class="dot off" id="connDot"></span>
            <span id="connText">Leitstelle</span>
          </span>
          <button class="btn btnGhost btnLogoutRed" id="btnLogout" title="Logout">Logout</button>
        </div>
      </div>

      <div class="content">
        <!-- ✅ Collapsible Beamter erstellen -->
        <div class="field collapseCard" id="createCard">
          <div class="collapseHead" id="createToggle" title="Ein-/Ausklappen">
            <div class="collapseTitle">
              <span>Beamter erstellen</span>
              <span class="muted" id="createMiniHint" style="display:none;">(eingeklappt)</span>
            </div>
            <div class="chev" id="createChev">⌃</div>
          </div>

          <div class="collapseBody" id="createBody">
            <input id="inpName" placeholder="Name (z.B. John Doe)"/>

            <div style="height:10px"></div>
            <label>Dienstnummer</label>
            <input id="inpDienstnr" placeholder="z.B. 4711"/>

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn btnPrimary" id="btnCreateOfficer">Beamter speichern</button>
              <!-- ✅ umfunktioniert -->
              <button class="btn btnGhost" id="btnRemember">Eingaben löschen</button>
            </div>

            <div style="height:10px"></div>
            <div class="row" style="align-items:center;">
              <span class="muted" id="meHint"></span>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <div class="row" style="align-items:center; justify-content:space-between;">
            <label style="margin:0;">Beamten Pool</label>
            <span class="pill"><span class="dot red"></span><span id="createdCount">0</span></span>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <input id="inpSearch" placeholder="Suche (Name oder DN)"/>
          </div>

          <div style="height:10px"></div>

          <div class="dropZone" id="createdList" data-dropzone="1" data-patrol-id=""></div>
        </div>
      </div>
    </section>

    <!-- CENTER -->
    <section class="panel" id="panelCenter">
      <div class="panelHeader">
        <!-- ✅ links oben nur Titel -->
        <div class="brand">
          <div class="titleWrap">
            <div class="title">STREIFENEINTEILUNG</div>
          </div>
        </div>

        <!-- ✅ +Streife länger, Zähler rechts -->
        <div class="topActions">
          <span class="pill" title="Gesamtzahl Beamte im Dienst (10-1)">
            <span class="dot on"></span><span id="onDutyCount">0</span>
          </span>

          <button class="btn btnWide" id="btnAddPatrol">+ Streife</button>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="patrolGrid"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel collapseX" id="panelRight">
      <div class="dockBtn" id="btnToggleRight" title="Rechts ein/aus">❯</div>

      <div class="panelHeader">
        <div class="brand">
          <div class="badge">⟡</div>
          <div class="titleWrap">
            <div class="title">INFO</div>
            <div class="subtitle">Notizen, Funcodes, Funkkanäle</div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="field">
          <label>Notizen (Auto-Save)</label>
          <textarea id="txtNotes" placeholder="Einsatznotizen, BOLO, Kennzeichen, Besonderheiten…"></textarea>
          <div class="muted" id="noteStatus" style="margin-top:8px;">—</div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funcodes</h3>
          <div class="codeList" id="funcodeList"></div>
        </div>

        <div style="height:12px"></div>

        <div class="field rightBox">
          <h3>Funkkanäle</h3>
          <div class="codeList">
            <div class="codeRow"><b>LSPD</b><span>-1</span></div>
            <div class="codeRow"><b>LSMD</b><span>-2</span></div>
            <div class="codeRow"><b>DOJ</b><span>-3</span></div>
            <div class="codeRow"><b>Army</b><span>-6</span></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Edge buttons appear when panels are collapsed -->
  <div class="edgeBtn" id="edgeLeft" title="Links öffnen">❯</div>
  <div class="edgeBtn" id="edgeRight" title="Rechts öffnen">❮</div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const SUPABASE_URL = "https://vuowfnmavgfkvabdtelx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1b3dmbm1hdmdma3ZhYmR0ZWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyOTM1MjQsImV4cCI6MjA4Nzg2OTUyNH0.R-oI8UzrP_ovDePN11wN2zFDifERkMOHZfNckjHLwhg";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: { params: { eventsPerSecond: 10 } }
    });

    /***********************
     * ✅ LOGIN (Supabase Auth)
     ***********************/
    const loginOverlay = document.getElementById("loginOverlay");
    const inpLoginName = document.getElementById("inpLoginName");
    const inpLoginPw = document.getElementById("inpLoginPw");
    const btnLogin = document.getElementById("btnLogin");
    const loginErr = document.getElementById("loginErr");

    const btnLogout = document.getElementById("btnLogout");

    function normalizeSpaces(s){
      return (s ?? "").toString().replace(/\s+/g, " ").trim();
    }
    function normalizeKey(name){
      return normalizeSpaces(name).toLowerCase();
    }
    function emailFromName(name){
      const key = normalizeKey(name);
      return key ? `${key}@gta.local` : "";
    }

    function showLogin(errMsg = ""){
      loginOverlay.style.display = "flex";
      app.style.display = "none";
      loginErr.style.display = errMsg ? "block" : "none";
      loginErr.textContent = errMsg || "";
      setTimeout(()=> inpLoginName.focus(), 50);
    }
    function hideLogin(){
      loginOverlay.style.display = "none";
      app.style.display = "grid";
    }

    function friendlyAuthError(error){
      const msg = (error?.message || "").toLowerCase();
      if(msg.includes("invalid login") || msg.includes("invalid credentials") || msg.includes("invalid email or password")){
        return "Falscher Name oder Passwort.";
      }
      if(msg.includes("email not confirmed")){
        return "Account ist noch nicht bestätigt.";
      }
      if(msg.includes("too many requests") || msg.includes("rate limit")){
        return "Zu viele Versuche. Bitte kurz warten.";
      }
      return "Login fehlgeschlagen.";
    }

    async function doLogin(){
      const name = normalizeSpaces(inpLoginName.value);
      const pw = (inpLoginPw.value ?? "").toString();
      loginErr.style.display = "none";
      loginErr.textContent = "";

      if(!name) return showLogin("Bitte Namen eingeben.");
      if(!pw) return showLogin("Bitte Passwort eingeben.");

      const email = emailFromName(name);
      try{
        btnLogin.disabled = true;
        btnLogin.textContent = "Login…";

        const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
        if(error) throw error;

        hideLogin();
        toast("Eingeloggt");
      }catch(e){
        console.error(e);
        showLogin(friendlyAuthError(e));
      }finally{
        btnLogin.disabled = false;
        btnLogin.textContent = "Login";
      }
    }

    async function doLogout(){
      try{
        await sb.auth.signOut();
      }catch(e){
        console.error(e);
      }
      showLogin("");
      toast("Ausgeloggt");
    }

    /***********************
     * FUNKCODES (rechts nur Info)
     ***********************/
    const FUNCODES = [
      ["10-1", "Im Dienst"], ["10-2", "Außer Dienst"], ["10-4", "Verstanden"], ["10-5", "Verstärkung"],
      ["10-6", "Funkspruch wiederholen"], ["10-7", "Overwatch benötigt"], ["10-15", "TV in Gewahrsam"],
      ["10-33", "Verunfallt"], ["10-50", "Verkehrsunfall"], ["10-60", "Allgemeine Verkehrskontrolle"],
      ["10-80", "Verfolgungsjagd"], ["11-90", "Officers in Bedrängnis"], ["11-99", "Officer unter Beschuss"],
      ["10-20", "Positionsabfrage"], ["10-22", "Abholung benötigt"], ["CODE 0", "Kopfschmerzen"],
      ["CODE 1", "Auf Streife"], ["CODE 2", "Anfahrt ohne Sondersignal"], ["CODE 3", "Anfahrt mit Sondersignal"],
      ["CODE 4", "Einsatz Ende / unter Kontrolle"], ["CODE 7", "Nicht einsatzbereit"], ["CODE 99", "Möglicher Hinterhalt"]
    ];

    /***********************
     * STATUS pro Streife
     ***********************/
    const PATROL_STATUSES = [
      "Auf Streife",
      "Stand-By",
      "Einsatz",
      "Pause",
      "Im PD",
      "Ausbildung"
    ];

    function escapeHtml(s){
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function statusOptionsHtml(selected){
      return PATROL_STATUSES.map(v=>{
        const sel = (selected === v) ? "selected" : "";
        return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(v)}</option>`;
      }).join("");
    }
    function statusLabel(v){
      return v || "Auf Streife";
    }

    /***********************
     * DOM
     ***********************/
    const app = document.getElementById("app");
    const btnToggleLeft = document.getElementById("btnToggleLeft");
    const btnToggleRight = document.getElementById("btnToggleRight");
    const edgeLeft = document.getElementById("edgeLeft");
    const edgeRight = document.getElementById("edgeRight");

    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText"); // bleibt "Leitstelle"

    const toastEl = document.getElementById("toast");

    const inpName = document.getElementById("inpName");
    const inpDienstnr = document.getElementById("inpDienstnr");

    const btnCreateOfficer = document.getElementById("btnCreateOfficer");
    const btnRemember = document.getElementById("btnRemember");
    const meHint = document.getElementById("meHint");

    const inpSearch = document.getElementById("inpSearch");
    const createdList = document.getElementById("createdList");
    const createdCount = document.getElementById("createdCount");

    const patrolGrid = document.getElementById("patrolGrid");
    const btnAddPatrol = document.getElementById("btnAddPatrol");

    const onDutyCountEl = document.getElementById("onDutyCount");

    const txtNotes = document.getElementById("txtNotes");
    const noteStatus = document.getElementById("noteStatus");

    const funcodeList = document.getElementById("funcodeList");

    /* Collapsible create panel */
    const createCard = document.getElementById("createCard");
    const createToggle = document.getElementById("createToggle");
    const createMiniHint = document.getElementById("createMiniHint");

    /***********************
     * COLLAPSE STATE (persist)
     ***********************/
    const LS_UI = "lspd_ui_panels";
    function loadUi(){
      try{
        const raw = localStorage.getItem(LS_UI);
        const v = raw ? JSON.parse(raw) : {};
        return { left: !!v.left, right: !!v.right };
      }catch{ return { left:false, right:false }; }
    }
    function saveUi(state){
      try{ localStorage.setItem(LS_UI, JSON.stringify(state)); }catch{}
    }
    const ui = loadUi();
    function applyUi(){
      app.classList.toggle("leftCollapsed", ui.left);
      app.classList.toggle("rightCollapsed", ui.right);
      btnToggleLeft.textContent = ui.left ? "❯" : "❮";
      btnToggleRight.textContent = ui.right ? "❮" : "❯";
    }
    btnToggleLeft.addEventListener("click", ()=>{ ui.left = !ui.left; saveUi(ui); applyUi(); });
    btnToggleRight.addEventListener("click", ()=>{ ui.right = !ui.right; saveUi(ui); applyUi(); });
    edgeLeft.addEventListener("click", ()=>{ ui.left = false; saveUi(ui); applyUi(); });
    edgeRight.addEventListener("click", ()=>{ ui.right = false; saveUi(ui); applyUi(); });

    /* Collapsible "Beamter erstellen" state */
    const LS_CREATE_COLLAPSE = "lspd_create_collapsed";
    function loadCreateCollapsed(){
      try{ return localStorage.getItem(LS_CREATE_COLLAPSE) === "1"; }catch{ return false; }
    }
    function saveCreateCollapsed(v){
      try{ localStorage.setItem(LS_CREATE_COLLAPSE, v ? "1":"0"); }catch{}
    }
    let createCollapsed = loadCreateCollapsed();
    function applyCreateCollapsed(){
      createCard.classList.toggle("collapsedUp", createCollapsed);
      createMiniHint.style.display = createCollapsed ? "inline" : "none";
    }
    createToggle.addEventListener("click", ()=>{
      createCollapsed = !createCollapsed;
      saveCreateCollapsed(createCollapsed);
      applyCreateCollapsed();
    });

    /***********************
     * STATE
     ***********************/
    let patrols = [];
    let officers = [];
    let noteAutosaveTimer = null;

    let sortables = [];
    let patrolSortable = null;

    let selectedOfficerId = null;

    let rtChannels = [];
    let rtResubTimer = null;

    const LS_PATROL_ORDER = "lspd_patrol_order";
    function loadPatrolOrder(){
      try{
        const raw = localStorage.getItem(LS_PATROL_ORDER);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.map(Number).filter(n => Number.isFinite(n)) : [];
      }catch{ return []; }
    }
    function savePatrolOrder(order){
      try{ localStorage.setItem(LS_PATROL_ORDER, JSON.stringify(order)); }catch{}
    }
    function normalizePatrolOrder(){
      const order = loadPatrolOrder();
      const ids = patrols.map(p => p.id);
      const set = new Set(ids);
      const cleaned = order.filter(id => set.has(id));
      for(const id of ids){
        if(!cleaned.includes(id)) cleaned.push(id);
      }
      savePatrolOrder(cleaned);
      return cleaned;
    }

    /***********************
     * ✅ ONLINE-INDIKATOR (stabil, kein Flackern)
     ***********************/
    let lastRealtimeOkAt = 0;
    let connWatchTimer = null;

    function markRealtimeOk(){
      lastRealtimeOkAt = Date.now();
    }
    function applyConnUi(isOnline){
      connDot.classList.toggle("on", isOnline);
      connDot.classList.toggle("off", !isOnline);
      // Text bleibt fest "Leitstelle"
      if(connText) connText.textContent = "Leitstelle";
    }
    function startConnWatch(){
      if(connWatchTimer) clearInterval(connWatchTimer);
      connWatchTimer = setInterval(() => {
        const age = Date.now() - lastRealtimeOkAt;
        const online = age < 7000;
        applyConnUi(online);
      }, 600);
    }

    /***********************
     * UI HELPERS
     ***********************/
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1800);
    }
    function timeAgo(iso){
      try{
        const t = new Date(iso).getTime();
        const diff = Math.max(0, Date.now() - t);
        const min = Math.floor(diff/60000);
        if(min < 1) return "gerade eben";
        if(min < 60) return `${min} min`;
        const h = Math.floor(min/60);
        return `${h} h`;
      }catch{ return "—"; }
    }
    function upsertLocal(arr, row){
      const i = arr.findIndex(x => x.id === row.id);
      if(i >= 0) arr[i] = row;
      else arr.push(row);
    }

    function dnNum(v){
      const s = (v ?? "").toString().trim();
      if(!s) return Number.POSITIVE_INFINITY;
      const n = parseInt(s.replace(/[^\d]/g, ""), 10);
      return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY;
    }

    function updateOnDutyCount(){
      const cnt = officers.filter(o => o.status === "10-1").length;
      onDutyCountEl.textContent = cnt;
    }

    function selectOfficerForEdit(officerId){
      const o = officers.find(x => x.id === officerId);
      if(!o) return;
      selectedOfficerId = officerId;
      inpName.value = o.name ?? "";
      inpDienstnr.value = (o.dienstnummer ?? "").toString();
      meHint.textContent = `Bearbeiten: ${o.name || "Officer"} (DN ${o.dienstnummer || "—"})`;
      setTimeout(()=>{ if(meHint.textContent.startsWith("Bearbeiten:")) meHint.textContent = ""; }, 3500);
      renderCreatedPool();
      if(createCollapsed){
        createCollapsed = false;
        saveCreateCollapsed(false);
        applyCreateCollapsed();
      }
    }
    function clearOfficerSelection(){
      selectedOfficerId = null;
      renderCreatedPool();
    }

    /***********************
     * RENDER ALL
     ***********************/
    function renderAll(){
      renderCreatedPool();
      renderPatrolGrid();
      updateOnDutyCount();
    }

    /***********************
     * RENDER
     ***********************/
    function renderFuncodes(){
      funcodeList.innerHTML = FUNCODES.map(([c, d]) => `
        <div class="codeRow"><b>${escapeHtml(c)}</b><span>${escapeHtml(d)}</span></div>
      `).join("");
    }

    function matchesSearch(officer, q){
      if(!q) return true;
      const name = (officer.name ?? "").toString().toLowerCase();
      const dn = (officer.dienstnummer ?? "").toString().toLowerCase();
      return name.includes(q) || dn.includes(q);
    }

    function renderCreatedPool(){
      const q = (inpSearch.value ?? "").trim().toLowerCase();
      let pool = officers.filter(o => o.patrol_id == null);
      if(q) pool = pool.filter(o => matchesSearch(o, q));

      pool = pool.slice().sort((a,b)=>{
        const da = dnNum(a.dienstnummer), db = dnNum(b.dienstnummer);
        if(da !== db) return da - db;
        return (a.name||"").localeCompare(b.name||"");
      });

      createdCount.textContent = pool.length;

      if(pool.length === 0){
        createdList.innerHTML = `<div class="muted">Keine Treffer im Pool.</div>`;
        return;
      }

      createdList.innerHTML = pool.map(o => {
        const isOn = o.status === "10-1";
        const dn = o.dienstnummer ? `DN ${o.dienstnummer}` : "DN —";
        const selected = (selectedOfficerId === o.id) ? "selected" : "";

        return `
          <div class="officerLine clickable ${selected}" data-officer-id="${o.id}" title="Klicken zum Bearbeiten">
            <div style="display:flex; gap:10px; align-items:flex-start; min-width:0; flex:1;">
              <div class="dragHandle" title="Ziehen">≡</div>

              <div style="min-width:0; flex:1;">
                <div style="display:flex; align-items:center; gap:8px; min-width:0;">
                  <span class="dot ${isOn ? "on":"off"}"></span>
                  <strong style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${escapeHtml(o.name)}
                  </strong>
                  ${isOn ? `<span class="pill">10-1</span>` : ``}
                </div>

                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  <span class="pill">${escapeHtml(dn)}</span>
                </div>

                <div class="muted" style="margin-top:6px;">zuletzt: ${escapeHtml(timeAgo(o.last_seen))}</div>
              </div>
            </div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn btnDanger" data-act="remove" data-id="${o.id}">Löschen</button>
            </div>
          </div>
        `;
      }).join("");

      createdList.querySelectorAll(".officerLine.clickable").forEach(line=>{
        line.addEventListener("click", (e)=>{
          if(e.target.closest("button")) return;
          if(e.target.closest(".dragHandle")) return;

          const id = Number(line.getAttribute("data-officer-id"));
          if(selectedOfficerId === id){
            clearOfficerSelection();
            toast("Auswahl aufgehoben");
            return;
          }
          selectOfficerForEdit(id);
        });
      });

      createdList.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          const act = btn.getAttribute("data-act");
          const id = Number(btn.getAttribute("data-id"));
          if(act === "remove") return deleteOfficer(id);
        });
      });
    }

    function renderPatrolGrid(){
      for(const s of sortables){ try{s.destroy();}catch{} }
      sortables = [];
      if(patrolSortable){ try{patrolSortable.destroy();}catch{} patrolSortable = null; }

      const order = normalizePatrolOrder();
      const orderIndex = new Map(order.map((id,i)=>[id,i]));
      const sortedPatrols = patrols.slice().sort((a,b)=>{
        const ia = orderIndex.has(a.id) ? orderIndex.get(a.id) : 1e9;
        const ib = orderIndex.has(b.id) ? orderIndex.get(b.id) : 1e9;
        if(ia !== ib) return ia - ib;
        return a.id - b.id;
      });

      patrolGrid.innerHTML = sortedPatrols.map(p => {
        const list = officers.filter(o => o.patrol_id === p.id).slice()
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

        const status = p.funcode || "Auf Streife";

        const lines = list.length ? list.map(o => {
          const dn = o.dienstnummer ? `DN ${o.dienstnummer}` : "DN —";
          return `
            <div class="officerLine" data-officer-id="${o.id}">
              <div style="display:flex; gap:10px; align-items:center; min-width:0;">
                <div class="dragHandle" title="Ziehen">≡</div>
                <div style="min-width:0;">
                  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <span class="dot ${o.status === "10-1" ? "on":"off"}"></span>
                    <strong>${escapeHtml(o.name)}</strong>
                    <span class="pill">${escapeHtml(dn)}</span>
                  </div>
                  <!-- ✅ Status-Text unter dem Namen entfernt -->
                </div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn btnBack" data-act="backToPool" data-id="${o.id}">Zurück in Pool</button>
              </div>
            </div>
          `;
        }).join("") : `<div class="muted">Ziehe Beamte hierher…</div>`;

        return `
          <div class="card" data-patrol-card="${p.id}">
            <div class="cardHeader">
              <div class="patrolDrag" title="Streife verschieben">⋮⋮</div>

              <div class="patrolName">
                <input value="${escapeHtml(p.name)}" data-act="renamePatrol" data-id="${p.id}" title="Streifenname bearbeiten"/>
              </div>

              <select class="statusSelect" data-act="patrolStatus" data-id="${p.id}" title="Status wählen">
                ${statusOptionsHtml(status)}
              </select>

              <button class="btn btnDanger" data-act="deletePatrol" data-id="${p.id}" title="Streife löschen">✕</button>
            </div>

            <div class="cardBody">
              <div class="pill" title="Aktueller Status">
                <b style="opacity:.9;">Status:</b> ${escapeHtml(statusLabel(status))}
              </div>
              <div style="height:10px"></div>

              <div class="dropZone" data-dropzone="1" data-patrol-id="${p.id}">
                ${lines}
              </div>
            </div>
          </div>
        `;
      }).join("");

      patrolGrid.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-act");
          const id = Number(btn.getAttribute("data-id"));
          if(act === "deletePatrol") return deletePatrol(id);
          if(act === "backToPool") return moveOfficerToPatrolAndMaybeStatus(id, null, "10-2");
        });
      });

      patrolGrid.querySelectorAll("input[data-act='renamePatrol']").forEach(inp=>{
        inp.addEventListener("change", async ()=>{
          const id = Number(inp.getAttribute("data-id"));
          const name = inp.value.trim() || "Streife";
          await renamePatrol(id, name);
        });
      });

      patrolGrid.querySelectorAll("select[data-act='patrolStatus']").forEach(sel=>{
        sel.addEventListener("change", async ()=>{
          const id = Number(sel.getAttribute("data-id"));
          const status = sel.value;
          await updatePatrolStatus(id, status);
        });
      });

      initPatrolOrderDrag();
      initDragAndDrop();
    }

    const SORTABLE_SCROLL_OPTS = {
      scroll: true,
      scrollSensitivity: 90,
      scrollSpeed: 18,
      bubbleScroll: true
    };

    function initPatrolOrderDrag(){
      patrolSortable = new Sortable(patrolGrid, {
        animation: 160,
        handle: ".patrolDrag",
        draggable: ".card",
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        ...SORTABLE_SCROLL_OPTS,
        onEnd: () => {
          const ids = Array.from(patrolGrid.querySelectorAll(".card"))
            .map(el => Number(el.getAttribute("data-patrol-card")))
            .filter(n => Number.isFinite(n));
          savePatrolOrder(ids);
          toast("Streifen-Reihenfolge gespeichert");
        }
      });
    }

    function initDragAndDrop(){
      const zones = document.querySelectorAll(".dropZone[data-dropzone='1']");
      zones.forEach(zone=>{
        const sortable = new Sortable(zone, {
          group: "officers-shared",
          animation: 150,
          handle: ".dragHandle",
          ghostClass: "sortable-ghost",
          chosenClass: "sortable-chosen",
          ...SORTABLE_SCROLL_OPTS,
          onEnd: async (evt) => {
            const item = evt.item;
            const officerId = Number(item.getAttribute("data-officer-id"));
            const toZone = evt.to;
            const raw = toZone.getAttribute("data-patrol-id");
            const toPatrolId = (raw === "" || raw == null) ? null : Number(raw);

            const o = officers.find(x => x.id === officerId);
            if(!o) return;

            const same = (o.patrol_id == null && toPatrolId == null) || (o.patrol_id === toPatrolId);
            if(same) return;

            if(toPatrolId == null && selectedOfficerId === officerId){
              selectedOfficerId = null;
            }

            const autoStatus = (toPatrolId == null) ? "10-2" : "10-1";
            await moveOfficerToPatrolAndMaybeStatus(officerId, toPatrolId, autoStatus);
          }
        });
        sortables.push(sortable);
      });
    }

    /***********************
     * CRUD
     ***********************/
    async function loadAll(){
      const pRes = await sb.from("patrols").select("*").order("id", {ascending:true});
      if(pRes.error) throw pRes.error;
      patrols = pRes.data || [];

      const oRes = await sb.from("officers").select("*").order("id", {ascending:true});
      if(oRes.error) throw oRes.error;
      officers = oRes.data || [];

      const nRes = await sb.from("dispatch_notes").select("*").eq("id", 1).single();
      if(nRes.error) throw nRes.error;
      txtNotes.value = nRes.data?.content ?? "";

      normalizePatrolOrder();
      renderAll();
      noteStatus.textContent = `geladen • ${new Date().toLocaleTimeString()}`;
    }

    function findOfficerIdentity(name, dienstnummer){
      const dn = (dienstnummer ?? "").trim();
      if(dn) return officers.find(o => (o.dienstnummer ?? "").toString().trim() === dn);
      return officers.find(o => o.name === name);
    }

    async function upsertOfficer({name, dienstnummer, patrol_id, status, forceId=null}){
      const existing = forceId ? officers.find(o => o.id === forceId) : findOfficerIdentity(name, dienstnummer);

      const payload = {
        name,
        dienstnummer: (dienstnummer ?? "").trim() || null,
        patrol_id: (patrol_id === "" || patrol_id == null) ? null : Number(patrol_id),
        status,
        last_seen: new Date().toISOString()
      };

      if(existing){
        const optimistic = { ...existing, ...payload, id: existing.id };
        officers = officers.map(o => o.id === existing.id ? optimistic : o);
        renderAll();

        const res = await sb.from("officers").update(payload).eq("id", existing.id).select("*").single();
        if(res.error) throw res.error;
        upsertLocal(officers, res.data);
        renderAll();
        return res.data;
      }else{
        const res = await sb.from("officers").insert(payload).select("*").single();
        if(res.error) throw res.error;
        upsertLocal(officers, res.data);
        renderAll();
        return res.data;
      }
    }

    async function createOfficer(){
      const name = inpName.value.trim();
      const dienstnummer = inpDienstnr.value.trim();
      if(!name) return toast("Name ausfüllen");
      if(!dienstnummer) return toast("Dienstnummer ausfüllen");

      try{
        if(selectedOfficerId != null){
          const cur = officers.find(x => x.id === selectedOfficerId);
          if(!cur){
            selectedOfficerId = null;
            await upsertOfficer({ name, dienstnummer, patrol_id: null, status: "10-2" });
            toast("Beamter gespeichert");
            return;
          }
          await upsertOfficer({
            name,
            dienstnummer,
            patrol_id: cur.patrol_id,
            status: cur.status,
            forceId: selectedOfficerId
          });
          toast("Beamter gespeichert");
          clearOfficerSelection();
          return;
        }

        await upsertOfficer({ name, dienstnummer, patrol_id: null, status: "10-2" });
        toast("Beamter gespeichert");
      }catch(e){
        console.error(e);
        toast("Fehler: " + (e?.message || "save"));
      }
    }

    async function moveOfficerToPatrolAndMaybeStatus(officerId, toPatrolId, status){
      const o = officers.find(x => x.id === officerId);
      if(!o) return;

      const before = { ...o };
      const optimistic = {
        ...o,
        patrol_id: (toPatrolId == null ? null : Number(toPatrolId)),
        status: status ?? o.status,
        last_seen: new Date().toISOString()
      };

      officers = officers.map(x => x.id === officerId ? optimistic : x);
      renderAll();

      const res = await sb.from("officers")
        .update({ patrol_id: optimistic.patrol_id, status: optimistic.status, last_seen: optimistic.last_seen })
        .eq("id", officerId)
        .select("*")
        .single();

      if(res.error){
        console.error("moveOfficerToPatrol error:", res.error);
        toast("Fehler Verschieben: " + (res.error.message || "unknown"));
        officers = officers.map(x => x.id === officerId ? before : x);
        renderAll();
        return;
      }

      upsertLocal(officers, res.data);
      renderAll();

      if(toPatrolId == null) toast("In Pool");
      else toast("Auf Streife");
    }

    async function deleteOfficer(id){
      const before = officers.slice();
      officers = officers.filter(o => o.id !== id);
      if(selectedOfficerId === id) selectedOfficerId = null;
      renderAll();

      const res = await sb.from("officers").delete().eq("id", id);
      if(res.error){
        console.error("deleteOfficer error:", res.error);
        toast("Fehler Löschen: " + (res.error.message || "unknown"));
        officers = before;
        renderAll();
        return;
      }
      toast("Officer gelöscht");
    }

    async function addPatrol(){
      const res = await sb.from("patrols").insert({ name: "Neue Streife", funcode: "Auf Streife" }).select("*").single();
      if(res.error){ console.error("addPatrol error:", res.error); toast("Fehler +Streife: " + (res.error.message || "unknown")); return; }

      upsertLocal(patrols, res.data);
      patrols.sort((a,b)=>a.id-b.id);

      const order = loadPatrolOrder();
      if(!order.includes(res.data.id)) order.push(res.data.id);
      savePatrolOrder(order);

      renderAll();
      toast("Streife erstellt");
    }

    async function renamePatrol(id, name){
      const p = patrols.find(x => x.id === id);
      if(!p) return;

      const before = { ...p };
      patrols = patrols.map(x => x.id === id ? { ...x, name } : x);
      renderAll();

      const res = await sb.from("patrols").update({ name }).eq("id", id).select("*").single();
      if(res.error){
        console.error("renamePatrol error:", res.error);
        toast("Fehler Name: " + (res.error.message || "unknown"));
        patrols = patrols.map(x => x.id === id ? before : x);
        renderAll();
        return;
      }
      upsertLocal(patrols, res.data);
      renderAll();
      toast("Streifenname gespeichert");
    }

    async function updatePatrolStatus(id, status){
      const safe = PATROL_STATUSES.includes(status) ? status : "Auf Streife";

      const p = patrols.find(x => x.id === id);
      if(!p) return;

      const before = { ...p };
      patrols = patrols.map(x => x.id === id ? { ...x, funcode: safe } : x);
      renderAll();

      const res = await sb.from("patrols").update({ funcode: safe }).eq("id", id).select("*").single();
      if(res.error){
        console.error("updatePatrolStatus error:", res.error);
        toast("Fehler Status: " + (res.error.message || "unknown"));
        patrols = patrols.map(x => x.id === id ? before : x);
        renderAll();
        return;
      }
      upsertLocal(patrols, res.data);
      renderAll();
      toast("Status gespeichert");
    }

    async function deletePatrol(id){
      const beforePatrols = patrols.slice();
      const beforeOfficers = officers.slice();
      const beforeOrder = loadPatrolOrder();

      patrols = patrols.filter(p => p.id !== id);
      officers = officers.map(o => (o.patrol_id === id ? { ...o, patrol_id: null } : o));
      savePatrolOrder(beforeOrder.filter(x => x !== id));
      renderAll();

      const res = await sb.from("patrols").delete().eq("id", id);
      if(res.error){
        console.error("deletePatrol error:", res.error);
        toast("Fehler Löschen: " + (res.error.message || "unknown"));
        patrols = beforePatrols;
        officers = beforeOfficers;
        savePatrolOrder(beforeOrder);
        renderAll();
        return;
      }
      toast("Streife gelöscht");
    }

    async function saveNote(){
      const content = txtNotes.value ?? "";
      const res = await sb.from("dispatch_notes")
        .update({ content, updated_at: new Date().toISOString() })
        .eq("id", 1);

      if(res.error){
        console.error("saveNote error:", res.error);
        noteStatus.textContent = "Fehler beim Speichern";
        return;
      }
      noteStatus.textContent = `gespeichert • ${new Date().toLocaleTimeString()}`;
    }

    /***********************
     * REALTIME
     ***********************/
    function teardownRealtime(){
      try{ rtChannels.forEach(ch => { try{ sb.removeChannel(ch); }catch{} }); }catch{}
      rtChannels = [];
    }

    let rtBackoffMs = 800;
    function scheduleResubscribe(){
      if(rtResubTimer) clearTimeout(rtResubTimer);
      const wait = Math.min(rtBackoffMs, 8000);
      rtResubTimer = setTimeout(() => {
        teardownRealtime();
        setupRealtime();
      }, wait);
      rtBackoffMs = Math.min(rtBackoffMs * 1.6, 8000);
    }
    function resetBackoff(){
      rtBackoffMs = 800;
    }

    function setupRealtime(){
      try{ sb.realtime.connect(); }catch{}
      teardownRealtime();

      const chOfficers = sb.channel("rt-officers")
        .on("postgres_changes", { event:"*", schema:"public", table:"officers" }, (payload) => {
          markRealtimeOk();
          if(payload.eventType === "DELETE"){
            const id = payload.old?.id;
            officers = officers.filter(o => o.id !== id);
            if(selectedOfficerId === id) selectedOfficerId = null;
          }else{
            upsertLocal(officers, payload.new);
          }
          renderAll();
        })
        .subscribe((status) => {
          if(status === "SUBSCRIBED"){
            resetBackoff();
            markRealtimeOk();
          }
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            scheduleResubscribe();
          }
        });

      const chPatrols = sb.channel("rt-patrols")
        .on("postgres_changes", { event:"*", schema:"public", table:"patrols" }, (payload) => {
          markRealtimeOk();
          if(payload.eventType === "DELETE"){
            const id = payload.old?.id;
            patrols = patrols.filter(p => p.id !== id);
            officers = officers.map(o => (o.patrol_id === id ? { ...o, patrol_id: null } : o));
            const order = loadPatrolOrder().filter(x => x !== id);
            savePatrolOrder(order);
          }else{
            upsertLocal(patrols, payload.new);
            patrols.sort((a,b)=>a.id-b.id);
            normalizePatrolOrder();
          }
          renderAll();
        })
        .subscribe((status) => {
          if(status === "SUBSCRIBED"){
            resetBackoff();
            markRealtimeOk();
          }
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            scheduleResubscribe();
          }
        });

      const chNotes = sb.channel("rt-notes")
        .on("postgres_changes", { event:"UPDATE", schema:"public", table:"dispatch_notes" }, (payload) => {
          markRealtimeOk();
          const next = payload.new?.content ?? "";
          if (document.activeElement !== txtNotes) {
            txtNotes.value = next;
            noteStatus.textContent = `aktualisiert • ${new Date().toLocaleTimeString()}`;
          }
        })
        .subscribe((status) => {
          if(status === "SUBSCRIBED"){
            resetBackoff();
            markRealtimeOk();
          }
          if(status === "CHANNEL_ERROR" || status === "TIMED_OUT" || status === "CLOSED"){
            scheduleResubscribe();
          }
        });

      rtChannels.push(chOfficers, chPatrols, chNotes);
    }

    document.addEventListener("visibilitychange", () => {
      if(!document.hidden){
        markRealtimeOk();
        scheduleResubscribe();
      }
    });
    window.addEventListener("online", () => {
      markRealtimeOk();
      scheduleResubscribe();
    });

    /***********************
     * EVENTS
     ***********************/
    btnCreateOfficer.addEventListener("click", createOfficer);
    inpSearch.addEventListener("input", renderCreatedPool);

    btnAddPatrol.addEventListener("click", addPatrol);

    txtNotes.addEventListener("input", ()=>{
      noteStatus.textContent = "tippt…";
      if(noteAutosaveTimer) clearTimeout(noteAutosaveTimer);
      noteAutosaveTimer = setTimeout(async ()=>{ await saveNote(); }, 900);
    });

    // ✅ Eingaben löschen (statt merken)
    btnRemember.addEventListener("click", ()=>{
      inpName.value = "";
      inpDienstnr.value = "";
      try{ localStorage.removeItem("lspd_me"); }catch{}
      meHint.textContent = "Eingaben gelöscht";
      setTimeout(()=> meHint.textContent = "", 1500);
    });

    function loadRemembered(){
      // optional: falls noch alte Daten vorhanden sind (kannst du behalten)
      try{
        const raw = localStorage.getItem("lspd_me");
        if(!raw) return;
        const me = JSON.parse(raw);
        inpName.value = me.name || "";
        inpDienstnr.value = me.dienstnummer || "";
      }catch{}
    }

    // ✅ Login events (Enter bestätigt)
    inpLoginName.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); doLogin(); }
    });
    inpLoginPw.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); doLogin(); }
    });
    btnLogin.addEventListener("click", doLogin);
    btnLogout.addEventListener("click", doLogout);

    /***********************
     * INIT
     ***********************/
    (async function init(){
      applyUi();
      applyCreateCollapsed();
      renderFuncodes();

      applyConnUi(false);
      lastRealtimeOkAt = 0;
      startConnWatch();

      loadRemembered();

      // Auth: Session prüfen -> wenn vorhanden direkt rein, sonst Login overlay
      try{
        const { data } = await sb.auth.getSession();
        if(data?.session){
          hideLogin();
          toast("Eingeloggt");
        }else{
          showLogin("");
        }
      }catch(e){
        console.error(e);
        showLogin("Auth-Fehler.");
      }

      // Auth State Changes (z.B. Token refresh / logout in anderem Tab)
      sb.auth.onAuthStateChange((evt, session) => {
        if(session){
          hideLogin();
        }else{
          showLogin("");
        }
      });

      loadAll()
        .catch((e)=>{
          console.error(e);
          toast("Supabase/RLS prüfen: " + (e?.message || "unknown"));
          applyConnUi(false);
        });

      setupRealtime();
    })();
  </script>
</body>
</html>
